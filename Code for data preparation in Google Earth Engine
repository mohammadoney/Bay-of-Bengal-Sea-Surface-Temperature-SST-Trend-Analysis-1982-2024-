// 1. Define region
var geometry = ee.FeatureCollection("projects/ee-mohammadoney/assets/fullbayofbengal");

// 2. Load OISST data and apply scale factor
var oisst = ee.ImageCollection('NOAA/CDR/OISST/V2_1')
  .select(['sst'])
  .filterDate('1982-01-01', '2025-01-01')
  .filterBounds(geometry);

var sst_corrected = oisst.map(function(img) {
  return img.multiply(0.01).copyProperties(img, img.propertyNames());
});

// 3. Create monthly median composites
var startYear = 1982;
var endYear = 2024;

var months = ee.List.sequence(1, 12);

var monthlyComposites = ee.List([]);
for (var y = startYear; y <= endYear; y++) {
  var year = ee.Number(y);
  
  var monthly = months.map(function(m) {
    var month = ee.Number(m);
    
    // Filter for year and month
    var monthlyImages = sst_corrected.filter(ee.Filter.calendarRange(year, year, 'year'))
                                     .filter(ee.Filter.calendarRange(month, month, 'month'));
    
    // Compute median
    var medianImg = monthlyImages.median()
      .set('year', year)
      .set('month', month)
      .set('system:time_start', ee.Date.fromYMD(year, month, 1).millis());
    
    // Rename band to YYYY_MM
    var bandName = year.format().cat('_').cat(month.format('%02d'));
    medianImg = medianImg.rename(bandName);
    
    return medianImg;
  });
  
  monthlyComposites = monthlyComposites.cat(monthly);
}

// Convert list to ImageCollection
var monthlyCollection = ee.ImageCollection.fromImages(monthlyComposites);

// 4. Calculate mean for each month-year (full time series)
var timeSeriesData = monthlyCollection.map(function(image) {
  // Get year and month from properties
  var year = ee.Number(image.get('year'));
  var month = ee.Number(image.get('month'));
  var date = ee.Date.fromYMD(year, month, 1);
  
  // Get band name
  var bandName = image.bandNames().get(0);
  
  // Calculate mean over region
  var stats = image.reduceRegion({
    reducer: ee.Reducer.mean(),
    geometry: geometry.geometry(),
    scale: 27830,
    bestEffort: true,
    maxPixels: 1e13
  });
  
  // Get the mean value
  var meanValue = stats.get(bandName);
  
  // Create a feature for each month-year
  return ee.Feature(null, {
    'date': date.format('YYYY-MM-dd'),
    'year': year,
    'month': month,
    'month_name': date.format('MMM'),
    'year_month': year.format().cat('-').cat(month.format('%02d')),
    'mean_sst': meanValue,
    'system:time_start': date.millis()
  });
}).filter(ee.Filter.notNull(['mean_sst']));

// Sort by date
timeSeriesData = timeSeriesData.sort('system:time_start');

// Print first few records to check
print('First 5 records:', timeSeriesData.limit(5));
print('Total records:', timeSeriesData.size());

// 5. Export as CSV
Export.table.toDrive({
  collection: timeSeriesData,
  description: 'Monthly_SST_TimeSeries_Bay_of_Bengal_1982_2024',
  folder: 'earthengine',
  fileFormat: 'CSV',
  selectors: ['date', 'year', 'month', 'month_name', 'year_month', 'mean_sst']
});
